<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resource Allocation Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #333;
        }
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
        .loader-container {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(4px);
        }
        .loader {
            border: 8px solid #e2e8f0;
            border-radius: 50%;
            border-top: 8px solid #2c3e50;
            width: 60px;
            height: 60px;
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .card {
            background: white;
            transition: all 0.3s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .chart-card {
             background: white;
             border-radius: 15px;
             box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
             overflow: hidden;
             padding: 25px;
             transition: transform 0.3s ease;
        }
        .chart-card:hover {
            transform: translateY(-5px);
        }
        .chart-title {
            text-align: center;
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 700;
            padding-bottom: 15px;
            border-bottom: 3px solid #007bff;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="text-slate-800">

    <div id="loader-overlay" class="loader-container fixed inset-0 flex flex-col justify-center items-center z-50">
        <div class="loader"></div>
        <p class="mt-4 text-lg font-semibold text-slate-700">Fetching and analyzing resource data...</p>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8 p-8 bg-gradient-to-r from-slate-800 to-slate-900 rounded-xl shadow-lg text-white relative overflow-hidden">
             <h1 class="text-4xl md:text-5xl font-extrabold text-white"><i class="fas fa-chart-pie"></i> Resource Allocation</h1>
            <p id="headerDateRange" class="text-slate-300 mt-2 text-lg">Dashboard for team contributions</p>
        </header>

        <!-- Filters -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-8 flex flex-wrap gap-6 items-center">
            <h3 class="text-xl font-bold text-slate-700 w-full sm:w-auto"><i class="fas fa-filter"></i> Filters:</h3>
            <div class="w-full sm:w-auto flex-grow">
                 <label for="startDate" class="font-semibold text-slate-600 block mb-1">Start Date</label>
                <input type="date" id="startDate" class="w-full p-2 border border-slate-300 rounded-lg bg-slate-50 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
             <div class="w-full sm:w-auto flex-grow">
                <label for="endDate" class="font-semibold text-slate-600 block mb-1">End Date</label>
                <input type="date" id="endDate" class="w-full p-2 border border-slate-300 rounded-lg bg-slate-50 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="w-full sm:w-auto flex-grow">
                 <label for="teamFilter" class="font-semibold text-slate-600 block mb-1">Team</label>
                <select id="teamFilter" class="w-full p-2 border border-slate-300 rounded-lg bg-slate-50 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="All">All Teams</option>
                </select>
            </div>
            <div class="w-full sm:w-auto flex-grow">
                <label for="resourceFilter" class="font-semibold text-slate-600 block mb-1">Resource</label>
                <select id="resourceFilter" class="w-full p-2 border border-slate-300 rounded-lg bg-slate-50 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="All">All Resources</option>
                </select>
            </div>
            <div class="self-end">
                <button id="applyFilters" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors shadow-md hover:shadow-lg"><i class="fas fa-check"></i> Apply</button>
            </div>
        </div>
        
        <!-- Main Dashboard Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
            
            <!-- KPIs -->
            <div class="card bg-white p-6 rounded-xl shadow-lg flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-slate-500 mb-1">Total Hours Logged</h3>
                    <p id="totalHours" class="text-5xl font-extrabold text-indigo-600">0</p>
                </div>
                <div class="bg-indigo-100 p-4 rounded-full">
                   <i class="fas fa-clock fa-2x text-indigo-600"></i>
                </div>
            </div>
             <div class="card bg-white p-6 rounded-xl shadow-lg flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-slate-500 mb-1">Unique Tickets</h3>
                    <p id="totalTickets" class="text-5xl font-extrabold text-emerald-600">0</p>
                </div>
                 <div class="bg-emerald-100 p-4 rounded-full">
                    <i class="fas fa-ticket-alt fa-2x text-emerald-600"></i>
                </div>
            </div>
            <div class="card bg-white p-6 rounded-xl shadow-lg flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-slate-500 mb-1">Avg. Hours / Contributor</h3>
                    <p id="avgHours" class="text-5xl font-extrabold text-sky-600">0</p>
                </div>
                <div class="bg-sky-100 p-4 rounded-full">
                   <i class="fas fa-users-cog fa-2x text-sky-600"></i>
                </div>
            </div>

            <!-- Visualizations -->
            <div class="chart-card md:col-span-2 xl:col-span-2">
                <h3 class="chart-title">Overall Allocation by Project</h3>
                <div class="chart-container" style="height:350px;"><canvas id="projectAllocationChart"></canvas></div>
            </div>
            <div id="top-tickets-card" class="card md:col-span-2 xl:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                <div class="text-center mb-4 pb-4 border-b-2 border-slate-200">
                    <h3 class="text-xl font-bold text-slate-800">Top Contributing Tickets</h3>
                    <p id="topTicketsDateRange" class="text-sm text-slate-500 mt-1">For selected period</p>
                </div>
                <ul id="topTicketsList" class="space-y-3"></ul>
            </div>
            <div class="chart-card md:col-span-1">
                <h3 class="chart-title">Allocation by Team</h3>
                 <div class="chart-container"><canvas id="teamAllocationChart"></canvas></div>
            </div>
            <div class="chart-card md:col-span-1">
                <h3 class="chart-title">Allocation by Resource</h3>
                 <div class="chart-container"><canvas id="resourceAllocationChart"></canvas></div>
            </div>
            <div class="chart-card md:col-span-2 xl:col-span-3">
                <h3 class="chart-title">Weekly Contribution Trend (Hours)</h3>
                <div class="chart-container"><canvas id="weeklyTrendChart"></canvas></div>
            </div>
        </div>
    </div>

    <script type="module">
        const GITHUB_URLS = [
            "https://raw.githubusercontent.com/lilytan0217/itresources/main/combined_data.json",
            "https://raw.githubusercontent.com/lilytan0217/itresources/main/25Julyto1Aug2025.json",
            "https://raw.githubusercontent.com/lilytan0217/itresources/main/4to8aug25.json",
            "https://raw.githubusercontent.com/lilytan0217/itresources/main/11to15Aug.json",
            "https://raw.githubusercontent.com/lilytan0217/itresources/main/18-24Aug25.json",
            "https://raw.githubusercontent.com/lilytan0217/itresources/main/25Augto29Aug25.json",
            "https://raw.githubusercontent.com/lilytan0217/itresources/main/1septo7sep.json",
            "https://raw.githubusercontent.com/lilytan0217/itresources/main/8to12Sep25.json",
            "https://raw.githubusercontent.com/lilytan0217/itresources/main/15to21Sep25.json",
            "https://raw.githubusercontent.com/lilytan0217/itresources/main/22to27sep25.json"
        ];

        const PROJECT_KEYS = { fr: "FR", ibs: "IBS", par: "PAR", nm: "NM", onboard: "Onboard", champ: "Champ", internal: "Internal", theone: "TheOne", others: "Others" };
        const COLORS = ['#007bff', '#198754', '#ffc107', '#dc3545', '#6f42c1', '#fd7e14', '#20c997', '#6c757d', '#0dcaf0'];

        let allData = [];
        let charts = {};

        // --- DATA FETCHING AND PROCESSING ---
        function normalizeNewData(entry) {
            const normalized = { date: entry.date, name: entry.name, team: entry.team, resource: entry.resource, hours: entry.hours, ...Object.keys(PROJECT_KEYS).reduce((acc, key) => ({ ...acc, [key]: 0 }), {}) };
            const allTickets = [];

            if (entry.tickets && Array.isArray(entry.tickets)) {
                entry.tickets.forEach(ticket => {
                    const key = ticket.ticket_type.toLowerCase().replace(/\s+/g, '');
                    if (normalized.hasOwnProperty(key)) {
                        normalized[key] += ticket.contribution_percentage;
                    }
                    const ticketObject = {
                        id: ticket.ticket_id,
                        type: ticket.ticket_type,
                        percentage: ticket.contribution_percentage,
                        hours: (ticket.contribution_percentage / 100) * entry.hours,
                        description: ticket.ticket_name || ticket.description
                    };
                    allTickets.push(ticketObject);
                });
            }
            normalized.tickets = allTickets;
            return normalized;
        }
        
        async function fetchAndProcessData() {
            try {
                const responses = await Promise.all(GITHUB_URLS.map(url => fetch(url)));
                const jsonData = await Promise.all(responses.map(res => res.json()));

                let processedData = [];
                jsonData[0].forEach(item => { processedData.push({ ...item, tickets: [] }); });

                for (let i = 1; i < jsonData.length; i++) {
                    if (Array.isArray(jsonData[i])) {
                       jsonData[i].forEach(item => processedData.push(normalizeNewData(item)));
                    }
                }
                
                processedData.sort((a, b) => new Date(a.date) - new Date(b.date));
                return processedData;
            } catch (error) {
                console.error("Failed to fetch or process data:", error);
                document.getElementById('loader-overlay').innerHTML = `<div class="text-center"><h2 class="text-2xl font-bold text-red-600">Error Loading Data</h2><p class="text-slate-600 mt-2">Could not fetch data from GitHub. Please check the console.</p></div>`;
                return [];
            }
        }

        // --- UI AND CHARTING ---
        function populateFilters(data) {
            const teams = [...new Set(data.map(d => d.team))];
            const resources = [...new Set(data.map(d => d.resource))];
            
            const teamFilter = document.getElementById('teamFilter');
            teams.forEach(team => { teamFilter.add(new Option(team, team)); });

            const resourceFilter = document.getElementById('resourceFilter');
            resources.forEach(resource => { resourceFilter.add(new Option(resource, resource)); });
            
            if (data.length > 0) {
                document.getElementById('startDate').value = data[0].date;
                document.getElementById('endDate').value = data[data.length - 1].date;
            }
        }
        
        function destroyCharts() {
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};
        }

        function updateDashboard(data) {
            destroyCharts();
            document.querySelectorAll('.card, header, .grid > div, .chart-card').forEach(el => el.classList.add('fade-in'));
            
            const totalHours = data.reduce((sum, d) => sum + d.hours, 0);
            const allTicketIds = data.flatMap(d => (d.tickets || []).map(t => t.id));
            const uniqueTickets = new Set(allTicketIds);
            const uniqueContributors = new Set(data.map(d => d.name));
            const avgHours = uniqueContributors.size > 0 ? totalHours / uniqueContributors.size : 0;

            document.getElementById('totalHours').textContent = totalHours.toLocaleString(undefined, { maximumFractionDigits: 0 });
            document.getElementById('totalTickets').textContent = uniqueTickets.size.toLocaleString();
            document.getElementById('avgHours').textContent = avgHours.toFixed(1);

            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            document.getElementById('headerDateRange').textContent = `Data from ${startDate} to ${endDate}`;
            
            createProjectAllocationChart(data);
            createTeamAllocationChart(data);
            createResourceAllocationChart(data);
            createWeeklyTrendChart(data);
            updateTopTickets(data, startDate, endDate);
        }

        function createProjectAllocationChart(data) {
            const projectTotals = Object.keys(PROJECT_KEYS).reduce((acc, key) => ({ ...acc, [key]: 0 }), {});
            
            data.forEach(d => {
                Object.keys(projectTotals).forEach(key => {
                    projectTotals[key] += (d[key] / 100) * d.hours;
                });
            });
            
            const ctx = document.getElementById('projectAllocationChart').getContext('2d');
            charts.project = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.values(PROJECT_KEYS),
                    datasets: [{
                        label: 'Hours', data: Object.values(projectTotals), backgroundColor: COLORS,
                        borderColor: '#fff', borderWidth: 3, hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { font: { size: 14 } } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                                    return `${context.label}: ${context.parsed.toFixed(1)} hrs (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function createStackedBarChart(canvasId, data, groupBy) {
            const groups = [...new Set(data.map(d => d[groupBy]))];
            const projectDataByGroup = groups.reduce((acc, group) => ({ ...acc, [group]: Object.keys(PROJECT_KEYS).reduce((pAcc, pKey) => ({...pAcc, [pKey]: 0}), {}) }), {});

            data.forEach(d => {
                Object.keys(PROJECT_KEYS).forEach(key => {
                    projectDataByGroup[d[groupBy]][key] += (d[key] / 100) * d.hours;
                });
            });

            const datasets = Object.keys(PROJECT_KEYS).map((key, index) => ({
                label: PROJECT_KEYS[key],
                data: groups.map(group => projectDataByGroup[group][key]),
                backgroundColor: COLORS[index % COLORS.length]
            }));

            const ctx = document.getElementById(canvasId).getContext('2d');
            charts[groupBy] = new Chart(ctx, {
                type: 'bar',
                data: { labels: groups, datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { stacked: true, grid: { display: false } }, y: { stacked: true, beginAtZero: true, title: { display: true, text: 'Hours' } } },
                    plugins: { legend: { display: false }, tooltip: { mode: 'index' } }
                }
            });
        }

        function createTeamAllocationChart(data) { createStackedBarChart('teamAllocationChart', data, 'team'); }
        function createResourceAllocationChart(data) { createStackedBarChart('resourceAllocationChart', data, 'resource'); }
        
        function createWeeklyTrendChart(data) {
            const weeklyData = {};
            data.forEach(d => {
                const date = new Date(d.date);
                const year = date.getUTCFullYear();
                const week = Math.ceil((((date - new Date(year, 0, 1)) / 86400000) + new Date(year, 0, 1).getUTCDay() + 1) / 7);
                const weekKey = `${year}-W${String(week).padStart(2, '0')}`;
                
                if (!weeklyData[weekKey]) weeklyData[weekKey] = { hours: 0, date: new Date(year, 0, (week-1)*7+1) };
                weeklyData[weekKey].hours += d.hours;
            });
            
            const sortedWeeks = Object.keys(weeklyData).sort((a,b) => weeklyData[a].date - weeklyData[b].date);

            const ctx = document.getElementById('weeklyTrendChart').getContext('2d');
            charts.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedWeeks.map(key => weeklyData[key].date),
                    datasets: [{
                        label: 'Total Hours per Week', data: sortedWeeks.map(key => weeklyData[key].hours),
                        borderColor: '#007bff', backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        fill: true, tension: 0.4, pointBackgroundColor: '#007bff', pointRadius: 4, pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { type: 'time', time: { unit: 'week', tooltipFormat: 'MMM d, yyyy' }, title: { display: true, text: 'Week' } },
                        y: { beginAtZero: true, title: { display: true, text: 'Hours' } }
                    }
                }
            });
        }

        function updateTopTickets(data, startDate, endDate) {
            const ticketMap = {};
            const ticketsToExclude = ['1 Hour Leisure Time', 'No Reason Stated'];

            data.forEach(d => {
                if(d.tickets && d.tickets.length > 0) {
                    d.tickets.forEach(ticket => {
                        if (ticketsToExclude.includes(ticket.description)) {
                            return; // Skip this ticket
                        }
                        
                        const key = ticket.id; // Use ticket.id as the primary key
                        if (!key) return;

                        if (!ticketMap[key]) {
                            ticketMap[key] = { id: ticket.id, description: ticket.description, hours: 0, type: ticket.type };
                        }
                        
                        ticketMap[key].hours += ticket.hours;

                        // If the existing entry has no description but this one does, update it.
                        if (!ticketMap[key].description && ticket.description) {
                            ticketMap[key].description = ticket.description;
                        }
                    });
                }
            });

            const sortedTickets = Object.values(ticketMap).sort((a, b) => b.hours - a.hours).slice(0, 5);
            
            document.getElementById('topTicketsDateRange').textContent = `From ${startDate} to ${endDate}`;
            const listElement = document.getElementById('topTicketsList');
            listElement.innerHTML = '';
            
            if (sortedTickets.length === 0) {
                listElement.innerHTML = `<li class="text-slate-500 italic p-2 text-center">No detailed ticket data in selected range.</li>`;
                return;
            }

            sortedTickets.forEach((ticket, index) => {
                const li = document.createElement('li');
                li.className = 'flex items-start justify-between p-2 rounded-lg transition-colors hover:bg-slate-50';
                
                let displayName = ticket.id;
                if (displayName && displayName.startsWith('Others-')) {
                    displayName += ' (No Ticket)';
                }
                
                const displayDescription = ticket.description || 'No description available.';

                li.innerHTML = `
                    <div class="flex items-start overflow-hidden">
                        <span class="text-base font-bold text-slate-400 w-8 text-center">${index + 1}.</span>
                        <div class="flex flex-col ml-2">
                             <span class="font-bold text-slate-800" title="${displayName}">${displayName}</span>
                             <span class="text-sm text-slate-500 mt-1" title="${displayDescription}">${displayDescription}</span>
                        </div>
                    </div>
                    <span class="font-bold text-blue-600 bg-blue-100 px-2.5 py-1 rounded-full text-sm flex-shrink-0">${ticket.hours.toFixed(1)} hrs</span>
                `;
                listElement.appendChild(li);
            });
        }

        // --- INITIALIZATION AND EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', async () => {
            allData = await fetchAndProcessData();
            document.getElementById('loader-overlay').style.display = 'none';
            if (allData.length > 0) {
                populateFilters(allData);
                document.getElementById('applyFilters').click(); // Initial load
            }
        });
        
        document.getElementById('applyFilters').addEventListener('click', () => {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const team = document.getElementById('teamFilter').value;
            const resource = document.getElementById('resourceFilter').value;

            let filteredData = allData.filter(d => {
                return (!startDate || d.date >= startDate) && (!endDate || d.date <= endDate) && (team === 'All' || d.team === team) && (resource === 'All' || d.resource === resource);
            });
            updateDashboard(filteredData);
        });
    </script>
</body>
</html>

